<section id="detail">

  @if(!isLoading){

    <div class="mb-2">
      <h2 class="mb-1">OBSERVATION DE <span class="text-black">{{nomScientifique}}</span></h2>
      <h5>Référentiel taxonomique: <span class="text-black uppercase">
        {{obs["determination_referentiel"]}}
      </span></h5>
    </div>

    <div id="detail-container">
      <div id="detail-left">
        <div class="card-image-div-extended detail-image-div">
          <img
            alt="Image de l'observation"
            class="card-image-extended detail-image"
            src="{{selectedImage['binaire.href']}}"
            (click)="openBigImage()"
            (error)="commonService.onImageError($event)"/>
        </div>

        <div class="card-image-extended-subtitles detail-image-subtitles">
          <div><img alt="Logo creative commons" src="assets/Creative_Commons_white.png"></div>
          <p>Par {{obs['auteur_nom']}} CC BY SA 2.0</p>
        </div>

        <div class="image-carousel-wrapper detail-carousel-wrapper">
          <div #imageCarousel id="image-carousel">
            @for (image of obs.images; track image; let i = $index) {
              <div class="thumbnail" (click)="changeSelectedImage(image)">
                <img alt="Image de l'observation" height="90" width="115" [src]="image['binaire.href']">
              </div>
            }
          </div>

          @if(obs.images && obs.images.length > 3){
            <img alt="Scroll right" class="scroll-icon" src="assets/icons/chevron_right_brown.png" (click)="scrollImages()">
          }
        </div>

        <div id="help-box">
          <h5 class="uppercase mb-2">Pour vous aider</h5>

          <div class="mb-2">
            <h6 class="mb-1">Vérifier votre détermination</h6>
            <p><a class="underline-green" href="https://www.tela-botanica.org/flore/france-metropolitaine/" target="_blank" title="eflore">eflore</a></p>
          </div>

          <div>
            <h6 class="mb-1">Autres outils en ligne</h6>
            <p><a class="underline-green" href="https://www.tela-botanica.org/ressources/ressources-bibliographiques/ouvrages-numerises/" target="_blank" title="flores numérisées">Flores numérisées</a></p>
            <p><a class="underline-green" href="https://www.tela-botanica.org/eflore/bonnierpda/Bonnier.html" target="_blank" title="Flore Bonnier interactive">Flore Bonnier interactive</a></p>
            <p><a class="underline-green" href="https://www.tela-botanica.org/ressources/ressources-pedagogiques/cles-de-determination-en-ligne/" target="_blank" title="Clés de détermination">Clés de détermination</a></p>
          </div>
        </div>

      </div>

      <div id="detail-right">
        <div id="detail-obs">
          <h5 class="uppercase mb-2">Détails de l'observation</h5>
          <div id="detail-obs-container">
            <div id="detail-obs-left">
              <p>Observée à: <span class="text-black">{{obs.zone_geo}} @if(obs.id_zone_geo){ ({{departement}}) }, {{obs.pays}}</span></p>
              <p>Le: <span class="text-black">{{dateObservation}}</span></p>
              <p>@if(obs.lieudit){ Lieu dit: <span class="text-black">{{obs.lieudit}}</span><br> }
              @if(obs.station){ Station: <span class="text-black">{{obs.station}}</span><br> }
              @if(obs.milieu){ Milieu: <span class="text-black">{{obs.milieu}}</span> }
            </p>
          </div>
          <div id="detail-obs-right">
            <div id="detail-transmission">
              <p>Transmise le: <span class="text-black">{{dateTransmission}}</span></p>
              <p>Par: <span class="text-black">
                @if(profilUrl){
                  <a class="text-black" href="{{profilUrl}}" target="_blank">{{obs["auteur_nom"]}}</a>
                } @else {
                  {{obs["auteur.nom"]}}
                }
                @if(isAdmin && obs['auteur.courriel']){
                  <a href="mailto:{{obs['auteur_courriel']}}" target="_blank"> ({{obs['auteur_courriel']}})</a>
                }
              </span></p>
            </div>
            <div id="detail-obs-commentaire">
              <p>Commentaire: <span class="text-black">{{obs.commentaire}}</span></p>
            </div>
          </div>
        </div>

      </div>

      <div class="flex-start w-100 gap-1 mt-2" id="detail-buttons">
        <button class="button-primary button-link-white" (click)="openAddCommentOnObs('determination')"><span>Proposer une détermination</span></button>
        <button class="button-primary button-link-white" (click)="openAddCommentOnObs('commentaire')"><span>Ajouter un commentaire</span></button>
      </div>

      <div class="mt-2" id="detail-propositions">
        <h5 class="uppercase mb-1">Propositions et échanges</h5>
        @if(commentaires.length < 1){
          <div class="proposition-container">
            <div class="proposition-row">

              <div class="propositions-layout w-80">
                <div>Détermination Originale par {{obs["auteur.nom"]}}</div>
                <div>Score</div>
                <div>Vote</div>

                <div class="text-black">
                  @if(obs['determination_nn']){
                    <a class="text-black underline-green" href="{{telaUrl}}{{obs['determination.referentiel']}}-nn-{{obs['determination_nn']}}" target="_blank" title="lien vers eflore">{{nomScientifique}}</a>
                  } @else {
                    <span class="text-black">{{nomScientifique}}</span>
                  }
                </div>

                <div>
                  <p class="card-texte">0</p>
                </div>

                <div>
                  <img
                    alt="vote pour"
                    class="vote-icon"
                    title="voter pour cette proposition"
                    [src]="commonService.getVoteIconSrc('like', [], isHovered)"
                    (click)="voter('1', '0', obs.id_observation)"
                    (mouseout)="commonService.changeIconOnHoverSimple('like', false, isHovered)"
                    (mouseover)="commonService.changeIconOnHoverSimple('like', true, isHovered)">
                  <img alt="vote contre"
                    class="vote-icon"
                    title="voter contre cette proposition"
                    [src]="commonService.getVoteIconSrc('dislike', '', isHovered)"
                    (click)="voter('0', '0', obs.id_observation)"
                    (mouseout)="commonService.changeIconOnHoverSimple('dislike', false, isHovered)"
                    (mouseover)="commonService.changeIconOnHoverSimple('dislike', true, isHovered)">
                </div>
              </div>
              <div class="flex-start">
                @if(isAdmin){
                  <button class="button-accent button-link" title="Dépublier cette observation" (click)="affichagePopupConfirmation(obs.id_observation)">
                    <img alt="close icon" class="detail-icon" height=30 src="assets/icons/close_pink.png" width=30>
                    <span>Dépublier</span>
                  </button>
                }
              </div>

            </div>
            <div class="reponses-proposition-div">
              <p class="uppercase">
                <span class="">Veuillez voter afin de pouvoir ajouter un commentaire lié à cette proposition
                  @if(isVerificateur || (obs["auteur_id"] == userId) ){ ou la valider}
                  .</span>
                </p>
              </div>
            </div>
          } @else {
            @for(commentaire of commentairesGrouped.proposition; track commentaire.id_commentaire){
              <div class="proposition-container" [ngClass]="{'proposition-retenue': commentaire.proposition_retenue === 1}">

                <div class="text-black">
                  Détermination
                  @if(commentaire.proposition_initiale === 1){
                    originale
                  } @else {
                    proposée
                  }
                  par {{commentaire['auteur.nom']}} le {{commentaire.displayDate}}
                </div>

                <div class="proposition-row mt-1">
                  <div class="propositions-layout w-80">
                    <div>Proposition</div>
                    <div>Score</div>
                    <div>Vote</div>

                    <div class="text-black">
                      @if(commentaire.proposition_retenue === 1){
                        <img alt="Proposition validée icon" class="valid-icon" src="assets/icons/IPcheck.png" title="Proposition validée">
                      }

                      @if (!commentaire.nom_sel_nn){
                        <span class="text-black">{{commentaire.nom_sel}}</span>
                      } @else {
                        <a class="text-black underline-green" href="{{telaUrl}}{{commentaire.nom_referentiel}}-nn-{{commentaire.nom_sel_nn}}" target="_blank" title="lien vers eflore">{{commentaire.nom_sel}}</a>
                      }

                    </div>

                    <div>
                      <p class="card-texte">{{commentaire.score}}</p>
                    </div>

                    <div>
                      <img
                        alt="vote pour"
                        class="vote-icon"
                        title="voter pour cette proposition"
                        [src]="commonService.getVoteIconSrc('like', commentaire, isHovered)"
                        (click)="voter('1', commentaire.id_commentaire, obs.id_observation)"
                        (mouseout)="commonService.changeIconOnHover('like', commentaire, false)"
                        (mouseover)="commonService.changeIconOnHover('like', commentaire, true)">
                      <img
                        alt="vote contre"
                        class="vote-icon"
                        title="voter contre cette proposition"
                        [src]="commonService.getVoteIconSrc('dislike', commentaire,isHovered)"
                        (click)="voter('0', commentaire.id_commentaire, obs.id_observation)"
                        (mouseout)="commonService.changeIconOnHover('dislike', commentaire, false)"
                        (mouseover)="commonService.changeIconOnHover('dislike', commentaire, true)">
                      @if(commentaire.votes && commentaire.votes.length > 0){
                        <img alt="Détail des votes" class="vote-icon vote-detail-icon" src="assets/icons/ipBulles_brown.png" title="Voir le détail des {{commentaire.votes.length}} vote(s)" (click)="openDetailVotes(commentaire.id_commentaire)">
                      }
                    </div>
                  </div>
                </div>

                <div class="flex-start mb-2 text-black uppercase bold">

                  @if(isAllowedToValidate(commentaire)){

                    @if(commentaire.nom_sel_nn){
                      <button class="button-accent button-link" title="Valider la proposition" (click)="validerProposition(commentaire.id_commentaire, commentaire['auteur.id'])">
                        <img alt="validate icon" class="detail-icon" height=30 src="assets/icons/ip_valid.png" width=30>
                        <span>Valider</span>
                      </button>
                    } @else {
                      <span>Aucun numéro taxonomique relié à cette détermination, elle n'est donc n'est pas validable</span>
                    }

                  }

                  @if(isAdmin && commentaire.proposition_initiale == 1){
                    <button class="button-accent button-link" title="Dépublier cette observation" (click)="affichagePopupConfirmation(obs.id_observation)">
                      <img alt="close icon"  class="detail-icon" height=30 src="assets/icons/close_pink.png" width=30>
                      <span>Dépublier</span>
                    </button>
                  }
                </div>

                <div class="reponses-proposition-div">
                  <p class="pointer uppercase text-black bold" (click)="openAddComment('reponse', commentaire.id_commentaire)"><span class="button-text">Répondre</span></p>
                  @if(commentaire.reponses || commentaire.texte){
                    <app-commentaire [commentaires]="[commentaire]" [niveau]="0" />
                  }
                </div>
              </div>

              <!--    MODALS AREA     -->
              @if (popupAddCommentOnDetail && popupAddCommentOnDetailId === commentaire.id_commentaire){
                <app-popup-ajout-commentaire
                  class="blur-background"
                  [commentType]="commentType"
                  [id_parent]="commentaire.id_commentaire"
                  [obsId]="commentaire.observation"
                  [proposition]="commentaire.proposition"
                  (closePopupEmitter)="closeAddComment()" />
              }

              @if (popupDetailVotes === commentaire.id_commentaire){
                <app-popup-detail-votes
                  class="blur-background"
                  [commentaire]="commentaire"
                  [obs]="obs"
                  (closePopupEmitter)="closeDetailVotes()" />
              }

              @if(warningDeleteProposition && deletePropositionId == commentaire.id_commentaire){
                <div class="warning-popup">
                  <p>Etes-vous sûr de vouloir supprimer cette proposition ?</p>
                  <p>"{{commentaire.nom_sel}}"</p>
                  <p>Cliquez sur OK pour le supprimer malgré tout, ou sur Annuler pour retourner sur le détail de l'observation.</p>
                  <button type="button" (click)="confirmerDeleteProposition(commentaire.id_commentaire)">OK</button>
                  <button class="button-selected" type="button" (click)="cancelDeleteProposition()">Annuler</button>
                </div>
              }

              @if(deletePropositionErrorMessage){
                <div><p class="invalid-feedback">{{deletePropositionErrorMessage}}</p></div>
              }
              <!--    END OF MODALS AREA     -->

              }  <!--    END OF COMMENTAIRE FOR LOOP      -->
            }

            <!--        @if(voteErrorMessage){-->
            <!--        <div><p class="invalid-feedback">{{voteErrorMessage}}</p></div>-->
            <!--        }-->

            @if(validationErrorMessage){
              <div><p class="invalid-feedback">{{validationErrorMessage}}</p></div>
            }

            @if(depublierErrorMessage){
              <div><p class="invalid-feedback">{{depublierErrorMessage}}</p></div>
            }
          </div>

          <div class="mt-2" id="detail-commentaires">
            <h5 class="uppercase mb-1">Commentaires libres</h5>
            @for(commentaire of commentairesGrouped.commentaire; track commentaire.id_commentaire){
              @if(commentaire.texte){
                <div class="proposition-container">
                  <app-commentaire [commentaires]="[commentaire]" [isComLibre]="true" [niveau]="0" />
                </div>
              }
            }
          </div>
        </div>
      </div>

      <!--  <div id="comparer-image">-->
      <!--    <h5>Comparer cette image</h5>-->
      <!--    <input #inputElement type="text">-->
      <!--    <button (click)="comparer(inputElement.value)">Comparer</button>-->
    <!--  </div>-->

  } @else {
    <!--  Affichage du loader -->
    <div class="loader-container">
      <div class="loadership_COHKO">
        <div></div>
        <div></div>
      </div>
    </div>
  }

  @if (popupAddComment){
    <app-popup-ajout-commentaire
      class="blur-background"
      [commentType]="commentType"
      [obsId]="obs.id_observation"
      (closePopupEmitter)="closeAddCommentOnObs()" />
  }

  @if(showWarningPopup){
    <div class="warning-popup">
      <p>Etes-vous sûr de vouloir dépublier cette observation ?</p>
      <p>Cliquez sur OK pour valider malgré tout, ou sur Annuler pour retourner sur le détail de l'observation.</p>
      <div class="flex-between">
        <button class="button-secondary" type="button" (click)="cancelDepublier()">Annuler</button>
        <button class="button-primary" type="button" (click)="confirmerDepublier(obs.id_observation)">OK</button>
      </div>
    </div>
  }

  @if (popupBigImage){
    <app-popup-big-image
      class="blur-background"
      [images]="obs.images"
      [obs]="obs"
      [selectedImage]="selectedImage"
      (closePopupEmitter)="closeBigImagePopup()" />
  }

</section>

